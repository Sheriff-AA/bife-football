{% extends "base.html" %}

{% block content %}

<section class="text-gray-600 body-font">
  <div class="container px-5 py-6 mx-auto">
    <div class="flex flex-col text-center w-full mb-10">
      <h1 class="sm:text-4xl text-3xl font-medium title-font mb-2 text-gray-900">Teams</h1>
      <p class="lg:w-2/3 mx-auto leading-relaxed text-base">Teams, Organisations and Coaches</p>
    </div>

    <form>
      <label for="searchBox">Search:</label><br>
      <input id="searchBox" type="text" />
    </form>
    <p>
      <b id="resultsCount">0</b>
      Keywords found.
    </p>
    <div id="keywords"></div>
        
    <div class="lg:w-3/3 w-full mx-auto overflow-auto">
      <table class="table-auto w-full text-left">
        <thead>
          <tr>
            <th class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100 rounded-tl rounded-bl">Team</th>
            <th class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100">Short name</th>
            <th class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100">Coach</th>
            <th class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100">Organisation</th>
            <th class="px-4 py-3 title-font tracking-wider font-medium text-gray-900 text-sm bg-gray-100 rounded-tr rounded-br"></th>
          </tr>
        </thead>
        {% for team in page_obj %}
        <tbody>
          <tr>
          <td class="px-4 py-3">
              <a href="{% url 'teams:team-detail' team.pk %}">{{ team.team_name }}
              </a>
          </td>
          <td class="px-4 py-3">
              <a href="#">{{ team.short_team_name }}
              </a>
          </td>
          <td class="px-4 py-3">{{ team.coach.first }}</td>
          <td class="px-4 py-3 text-lg text-gray-900">{{ team.organisation }}</td>
          <td class="px-4 py-3 text-right text-lg underline text-blue-900">
            <a href="{% url 'teams:team-detail' team.pk %}">View team</a>
          </td>
          </tr>
        </tbody>
        {% endfor %}
      </table>
    </div>

    <div class="pagination">
      <span class="step-links">
          {% if page_obj.has_previous %}
              <a href="?page=1">&laquo; first</a>
              <a href="?page={{ page_obj.previous_page_number }}">previous</a>
          {% endif %}
  
          <span class="current">
              Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
          </span>
  
          {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}">next</a>
              <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
          {% endif %}
      </span>
    </div>

  </div>
</section>

<script>
  async function getData(url, paginateBy, startsWith) {
      const urlWithParams = url + "?" + new URLSearchParams({
          per_page: paginateBy,
          startswith: startsWith
      })
      const response = await fetch(urlWithParams);
      return response.json();
  }

  class Search {
      constructor(maxResults) {
          this.maxResults = maxResults
          this.container = document.querySelector("#keywords")
          this.resultsCount = document.querySelector("#resultsCount")
          this.input = document.querySelector("#searchBox")
          this.input.addEventListener("input", this.doSearch.bind(this))
      }

      addElement(keyword) {
          const pre = document.createElement("pre")
          pre.append(keyword)
          this.container.append(pre)
      }

      resetSearch() {
          this.container.innerHTML = '';
          this.resultsCount.innerHTML = 0;
      }

      doSearch() {
          const inputVal = this.input.value.toLowerCase();
          if (inputVal.length > 0) {
              getData("{% url 'teams:team-list' %}", this.maxResults, inputVal)
                  .then(response => {
                      this.resetSearch();
                      this.resultsCount.innerHTML = response.data.length;
                      response.data.forEach((el) => {
                          this.addElement(el.name)
                      });
                  });
          } else {
              this.resetSearch();
          }
      }
  }

  new Search(99);
</script>

{% endblock content %}
